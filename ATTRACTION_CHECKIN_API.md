# Attraction Check-In API Requirements

## Overview
The frontend now includes a QR code scanner for checking in attraction tickets. The following backend endpoints are required:

## Required Endpoints

### 1. Check-In Purchase (Mark as Used)
```
PATCH /attraction-purchases/{id}/check-in
```

**Description:** Marks a purchase ticket as used/completed when scanned at the attraction entrance.

**Request:**
- No body required
- Purchase ID is in the URL

**Response (Success):**
```json
{
  "success": true,
  "data": {
    "id": 123,
    "attraction_id": 5,
    "customer_id": 10,
    "guest_name": "John Doe",
    "guest_email": "john@example.com",
    "guest_phone": "+1234567890",
    "quantity": 2,
    "total_amount": 50.00,
    "payment_method": "credit",
    "status": "completed",
    "purchase_date": "2025-11-06",
    "notes": "Family package",
    "created_at": "2025-11-06T10:30:00Z",
    "updated_at": "2025-11-06T14:45:00Z",
    "attraction": {
      "id": 5,
      "name": "Zip Line Adventure"
    },
    "customer": {
      "id": 10,
      "first_name": "John",
      "last_name": "Doe",
      "email": "john@example.com"
    }
  },
  "message": "Ticket checked in successfully"
}
```

**Response (Error):**
```json
{
  "success": false,
  "message": "Ticket already used"
}
```

**Business Rules:**
- Only purchases with status `pending` can be checked in
- After check-in, status should be updated to `completed`
- Already completed tickets should return an error
- Cancelled tickets should return an error
- Update the `updated_at` timestamp

---

### 2. Verify Purchase (Check if Valid)
```
GET /attraction-purchases/{id}/verify
```

**Description:** Verifies if a purchase exists and returns its details without modifying it. Used before check-in to display ticket information.

**Request:**
- No body required
- Purchase ID is in the URL

**Response (Success):**
```json
{
  "success": true,
  "data": {
    "id": 123,
    "attraction_id": 5,
    "status": "pending",
    "quantity": 2,
    "total_amount": 50.00,
    "purchase_date": "2025-11-06",
    "attraction": {
      "id": 5,
      "name": "Zip Line Adventure",
      "price": 25.00
    },
    "customer": {
      "id": 10,
      "first_name": "John",
      "last_name": "Doe",
      "email": "john@example.com"
    },
    "guest_name": "John Doe",
    "guest_email": "john@example.com"
  }
}
```

**Response (Not Found):**
```json
{
  "success": false,
  "message": "Purchase not found"
}
```

---

## QR Code Format

The QR codes generated by the frontend contain JSON data:
```json
{
  "purchaseId": 123,
  "attractionName": "Zip Line Adventure",
  "customerEmail": "john@example.com",
  "quantity": 2,
  "purchaseDate": "2025-11-06"
}
```

The frontend extracts the `purchaseId` from the QR code and uses it to verify and check in tickets.

---

## Status Flow

```
pending â†’ completed (via check-in endpoint)
```

**Status Definitions:**
- `pending`: Ticket purchased but not yet used
- `completed`: Ticket checked in and used
- `cancelled`: Ticket cancelled/refunded (cannot be checked in)

---

## Frontend Implementation

The frontend component is located at:
- **File:** `src/pages/admin/attractions/AttractionCheckIn.tsx`
- **Route:** `/attractions/check-in`
- **Service:** `src/services/AttractionPurchaseService.ts`

**Features:**
1. Real-time camera QR scanning using html5-qrcode
2. Upload QR code image from file
3. Automatic ticket verification
4. One-time use validation (rejects already used tickets)
5. Detailed ticket information display
6. Success/error feedback with toast notifications

---

## Testing Checklist

- [ ] Check-in endpoint successfully marks pending purchases as completed
- [ ] Check-in endpoint rejects already completed tickets
- [ ] Check-in endpoint rejects cancelled tickets
- [ ] Check-in endpoint returns 404 for non-existent purchases
- [ ] Verify endpoint returns correct purchase details
- [ ] Verify endpoint returns 404 for non-existent purchases
- [ ] Updated timestamps are correct
- [ ] Includes attraction and customer relationship data
